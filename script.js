const productsData = {
    'step1-kraft-bow': [
        { name: 'Крафтовый пакет с бантом', price: 0, image: 'placeholder.jpg' }
    ],
    'step1-pvc': [
        { name: 'ПВХ пакет', price: 0, image: 'placeholder.jpg' }
    ],
    'step1-kraft-print': [
        { name: 'Крафтовый пакет с принтом', price: 100, image: 'placeholder.jpg' },
        { name: 'Крафтовый пакет с принтом 2', price: 100, image: 'placeholder.jpg' },
        { name: 'Крафтовый пакет с принтом 3', price: 100, image: 'placeholder.jpg' },
        { name: 'Крафтовый пакет с принтом 4', price: 100, image: 'placeholder.jpg' },
        { name: 'Крафтовый пакет с принтом 5', price: 100, image: 'placeholder.jpg' },
        { name: 'Крафтовый пакет с принтом 6', price: 100, image: 'placeholder.jpg' },
        { name: 'Крафтовый пакет с принтом 7', price: 100, image: 'placeholder.jpg' },
        { name: 'Крафтовый пакет с принтом 8', price: 100, image: 'placeholder.jpg' },
        { name: 'Крафтовый пакет с принтом 9', price: 100, image: 'placeholder.jpg' }
    ],
    'step1-cardboard': [
        { name: 'Пакет из картона', price: 120, image: 'placeholder.jpg' },
        { name: 'Пакет из картона 2', price: 120, image: 'placeholder.jpg' },
        { name: 'Пакет из картона 3', price: 120, image: 'placeholder.jpg' },
        { name: 'Пакет из картона 4', price: 120, image: 'placeholder.jpg' },
        { name: 'Пакет из картона 5', price: 120, image: 'placeholder.jpg' },
        { name: 'Пакет из картона 6', price: 120, image: 'placeholder.jpg' },
        { name: 'Пакет из картона 7', price: 120, image: 'placeholder.jpg' },
        { name: 'Пакет из картона 8', price: 120, image: 'placeholder.jpg' },
        { name: 'Пакет из картона 9', price: 120, image: 'placeholder.jpg' }
    ],
    'step2-no-box': [
        { name: 'Крафтовый конверт', price: 0, image: 'placeholder.jpg' },
        { name: 'Зип-пакет черный', price: 0, image: 'placeholder.jpg' }
    ],
    'step2-kraft-corrugated': [
        { name: 'Коробка из гофрокартона', price: 150, image: 'placeholder.jpg' },
        { name: 'Коробка из гофрокартона 2', price: 150, image: 'placeholder.jpg' },
        { name: 'Коробка из гофрокартона 3', price: 150, image: 'placeholder.jpg' },
        { name: 'Коробка из гофрокартона 4', price: 150, image: 'placeholder.jpg' },
        { name: 'Коробка из гофрокартона 5', price: 150, image: 'placeholder.jpg' },
        { name: 'Коробка из гофрокартона 6', price: 150, image: 'placeholder.jpg' },
        { name: 'Коробка из гофрокартона 7', price: 150, image: 'placeholder.jpg' },
        { name: 'Коробка из гофрокартона 8', price: 150, image: 'placeholder.jpg' },
        { name: 'Коробка из гофрокартона 9', price: 150, image: 'placeholder.jpg' }
    ],
    'step2-thick-cardboard': [
        { name: 'Коробка из толстого картона', price: 200, image: 'placeholder.jpg' },
        { name: 'Коробка из толстого картона 2', price: 200, image: 'placeholder.jpg' },
        { name: 'Коробка из толстого картона 3', price: 200, image: 'placeholder.jpg' },
        { name: 'Коробка из толстого картона 4', price: 200, image: 'placeholder.jpg' },
        { name: 'Коробка из толстого картона 5', price: 200, image: 'placeholder.jpg' },
        { name: 'Коробка из толстого картона 6', price: 200, image: 'placeholder.jpg' },
        { name: 'Коробка из толстого картона 7', price: 200, image: 'placeholder.jpg' },
        { name: 'Коробка из толстого картона 8', price: 200, image: 'placeholder.jpg' },
        { name: 'Коробка из толстого картона 9', price: 200, image: 'placeholder.jpg' }
    ],
    'step2-premium': [
        { name: 'Премиум коробка', price: 300, image: 'placeholder.jpg' },
        { name: 'Премиум коробка 2', price: 300, image: 'placeholder.jpg' },
        { name: 'Премиум коробка 3', price: 300, image: 'placeholder.jpg' },
        { name: 'Премиум коробка 4', price: 300, image: 'placeholder.jpg' },
        { name: 'Премиум коробка 5', price: 300, image: 'placeholder.jpg' },
        { name: 'Премиум коробка 6', price: 300, image: 'placeholder.jpg' },
        { name: 'Премиум коробка 7', price: 300, image: 'placeholder.jpg' },
        { name: 'Премиум коробка 8', price: 300, image: 'placeholder.jpg' },
        { name: 'Премиум коробка 9', price: 300, image: 'placeholder.jpg' }
    ],
    'step3-tissue-paper': [
        { name: 'Подложка из бумаги тишью', price: 80, image: 'placeholder.jpg' },
        { name: 'Подложка из бумаги тишью 2', price: 80, image: 'placeholder.jpg' },
        { name: 'Подложка из бумаги тишью 3', price: 80, image: 'placeholder.jpg' },
        { name: 'Подложка из бумаги тишью 4', price: 80, image: 'placeholder.jpg' },
        { name: 'Подложка из бумаги тишью 5', price: 80, image: 'placeholder.jpg' },
        { name: 'Подложка из бумаги тишью 6', price: 80, image: 'placeholder.jpg' },
        { name: 'Подложка из бумаги тишью 7', price: 80, image: 'placeholder.jpg' },
        { name: 'Подложка из бумаги тишью 8', price: 80, image: 'placeholder.jpg' },
        { name: 'Подложка из бумаги тишью 9', price: 80, image: 'placeholder.jpg' }
    ],
    'step3-corrugated-paper': [
        { name: 'Бумажный наполнитель гофрированный', price: 90, image: 'placeholder.jpg' },
        { name: 'Бумажный наполнитель гофрированный 2', price: 90, image: 'placeholder.jpg' },
        { name: 'Бумажный наполнитель гофрированный 3', price: 90, image: 'placeholder.jpg' },
        { name: 'Бумажный наполнитель гофрированный 4', price: 90, image: 'placeholder.jpg' },
        { name: 'Бумажный наполнитель гофрированный 5', price: 90, image: 'placeholder.jpg' },
        { name: 'Бумажный наполнитель гофрированный 6', price: 90, image: 'placeholder.jpg' },
        { name: 'Бумажный наполнитель гофрированный 7', price: 90, image: 'placeholder.jpg' },
        { name: 'Бумажный наполнитель гофрированный 8', price: 90, image: 'placeholder.jpg' },
        { name: 'Бумажный наполнитель гофрированный 9', price: 90, image: 'placeholder.jpg' }
    ],
    'step3-tissue': [
        { name: 'Тишью наполнитель', price: 100, image: 'placeholder.jpg' },
        { name: 'Тишью наполнитель 2', price: 100, image: 'placeholder.jpg' },
        { name: 'Тишью наполнитель 3', price: 100, image: 'placeholder.jpg' },
        { name: 'Тишью наполнитель 4', price: 100, image: 'placeholder.jpg' },
        { name: 'Тишью наполнитель 5', price: 100, image: 'placeholder.jpg' },
        { name: 'Тишью наполнитель 6', price: 100, image: 'placeholder.jpg' },
        { name: 'Тишью наполнитель 7', price: 100, image: 'placeholder.jpg' },
        { name: 'Тишью наполнитель 8', price: 100, image: 'placeholder.jpg' },
        { name: 'Тишью наполнитель 9', price: 100, image: 'placeholder.jpg' }
    ],
    'step3-foam': [
        { name: 'Пенопластовый наполнитель', price: 70, image: 'placeholder.jpg' },
        { name: 'Пенопластовый наполнитель 2', price: 70, image: 'placeholder.jpg' },
        { name: 'Пенопластовый наполнитель 3', price: 70, image: 'placeholder.jpg' },
        { name: 'Пенопластовый наполнитель 4', price: 70, image: 'placeholder.jpg' },
        { name: 'Пенопластовый наполнитель 5', price: 70, image: 'placeholder.jpg' },
        { name: 'Пенопластовый наполнитель 6', price: 70, image: 'placeholder.jpg' },
        { name: 'Пенопластовый наполнитель 7', price: 70, image: 'placeholder.jpg' },
        { name: 'Пенопластовый наполнитель 8', price: 70, image: 'placeholder.jpg' },
        { name: 'Пенопластовый наполнитель 9', price: 70, image: 'placeholder.jpg' }
    ],
    'step3-feathers': [
        { name: 'Наполнитель из перьев', price: 150, image: 'placeholder.jpg' },
        { name: 'Наполнитель из перьев 2', price: 150, image: 'placeholder.jpg' },
        { name: 'Наполнитель из перьев 3', price: 150, image: 'placeholder.jpg' },
        { name: 'Наполнитель из перьев 4', price: 150, image: 'placeholder.jpg' },
        { name: 'Наполнитель из перьев 5', price: 150, image: 'placeholder.jpg' },
        { name: 'Наполнитель из перьев 6', price: 150, image: 'placeholder.jpg' },
        { name: 'Наполнитель из перьев 7', price: 150, image: 'placeholder.jpg' },
        { name: 'Наполнитель из перьев 8', price: 150, image: 'placeholder.jpg' },
        { name: 'Наполнитель из перьев 9', price: 150, image: 'placeholder.jpg' }
    ],
    'step3-hearts': [
        { name: 'Наполнитель из атласных сердец', price: 200, image: 'placeholder.jpg' },
        { name: 'Наполнитель из атласных сердец 2', price: 200, image: 'placeholder.jpg' },
        { name: 'Наполнитель из атласных сердец 3', price: 200, image: 'placeholder.jpg' },
        { name: 'Наполнитель из атласных сердец 4', price: 200, image: 'placeholder.jpg' },
        { name: 'Наполнитель из атласных сердец 5', price: 200, image: 'placeholder.jpg' },
        { name: 'Наполнитель из атласных сердец 6', price: 200, image: 'placeholder.jpg' },
        { name: 'Наполнитель из атласных сердец 7', price: 200, image: 'placeholder.jpg' },
        { name: 'Наполнитель из атласных сердец 8', price: 200, image: 'placeholder.jpg' },
        { name: 'Наполнитель из атласных сердец 9', price: 200, image: 'placeholder.jpg' }
    ],
    'step4-kraft-plain': [
        { name: 'Крафтовая бумага без цвета', price: 60, image: 'placeholder.jpg' },
        { name: 'Крафтовая бумага без цвета 2', price: 60, image: 'placeholder.jpg' },
        { name: 'Крафтовая бумага без цвета 3', price: 60, image: 'placeholder.jpg' },
        { name: 'Крафтовая бумага без цвета 4', price: 60, image: 'placeholder.jpg' },
        { name: 'Крафтовая бумага без цвета 5', price: 60, image: 'placeholder.jpg' },
        { name: 'Крафтовая бумага без цвета 6', price: 60, image: 'placeholder.jpg' },
        { name: 'Крафтовая бумага без цвета 7', price: 60, image: 'placeholder.jpg' },
        { name: 'Крафтовая бумага без цвета 8', price: 60, image: 'placeholder.jpg' },
        { name: 'Крафтовая бумага без цвета 9', price: 60, image: 'placeholder.jpg' }
    ],
    'step4-kraft-print': [
        { name: 'Крафтовая бумага с принтом', price: 80, image: 'placeholder.jpg' },
        { name: 'Крафтовая бумага с принтом 2', price: 80, image: 'placeholder.jpg' },
        { name: 'Крафтовая бумага с принтом 3', price: 80, image: 'placeholder.jpg' },
        { name: 'Крафтовая бумага с принтом 4', price: 80, image: 'placeholder.jpg' },
        { name: 'Крафтовая бумага с принтом 5', price: 80, image: 'placeholder.jpg' },
        { name: 'Крафтовая бумага с принтом 6', price: 80, image: 'placeholder.jpg' },
        { name: 'Крафтовая бумага с принтом 7', price: 80, image: 'placeholder.jpg' },
        { name: 'Крафтовая бумага с принтом 8', price: 80, image: 'placeholder.jpg' },
        { name: 'Крафтовая бумага с принтом 9', price: 80, image: 'placeholder.jpg' }
    ],
    'step4-wrapping-paper': [
        { name: 'Оберточная бумага с принтом', price: 90, image: 'placeholder.jpg' },
        { name: 'Оберточная бумага с принтом 2', price: 90, image: 'placeholder.jpg' },
        { name: 'Оберточная бумага с принтом 3', price: 90, image: 'placeholder.jpg' },
        { name: 'Оберточная бумага с принтом 4', price: 90, image: 'placeholder.jpg' },
        { name: 'Оберточная бумага с принтом 5', price: 90, image: 'placeholder.jpg' },
        { name: 'Оберточная бумага с принтом 6', price: 90, image: 'placeholder.jpg' },
        { name: 'Оберточная бумага с принтом 7', price: 90, image: 'placeholder.jpg' },
        { name: 'Оберточная бумага с принтом 8', price: 90, image: 'placeholder.jpg' },
        { name: 'Оберточная бумага с принтом 9', price: 90, image: 'placeholder.jpg' }
    ],
    'step5-mini-card': [
        { name: 'Мини открытка', price: 0, image: 'placeholder.jpg' }
    ],
    'step5-mini-design': [
        { name: 'Мини открытка с дизайном', price: 50, image: 'placeholder.jpg' },
        { name: 'Мини открытка с дизайном 2', price: 50, image: 'placeholder.jpg' },
        { name: 'Мини открытка с дизайном 3', price: 50, image: 'placeholder.jpg' },
        { name: 'Мини открытка с дизайном 4', price: 50, image: 'placeholder.jpg' },
        { name: 'Мини открытка с дизайном 5', price: 50, image: 'placeholder.jpg' },
        { name: 'Мини открытка с дизайном 6', price: 50, image: 'placeholder.jpg' },
        { name: 'Мини открытка с дизайном 7', price: 50, image: 'placeholder.jpg' },
        { name: 'Мини открытка с дизайном 8', price: 50, image: 'placeholder.jpg' },
        { name: 'Мини открытка с дизайном 9', price: 50, image: 'placeholder.jpg' }
    ],
    'step5-3d-card': [
        { name: 'Открытка с 3D разворотом', price: 100, image: 'placeholder.jpg' },
        { name: 'Открытка с 3D разворотом 2', price: 100, image: 'placeholder.jpg' },
        { name: 'Открытка с 3D разворотом 3', price: 100, image: 'placeholder.jpg' },
        { name: 'Открытка с 3D разворотом 4', price: 100, image: 'placeholder.jpg' },
        { name: 'Открытка с 3D разворотом 5', price: 100, image: 'placeholder.jpg' },
        { name: 'Открытка с 3D разворотом 6', price: 100, image: 'placeholder.jpg' },
        { name: 'Открытка с 3D разворотом 7', price: 100, image: 'placeholder.jpg' },
        { name: 'Открытка с 3D разворотом 8', price: 100, image: 'placeholder.jpg' },
        { name: 'Открытка с 3D разворотом 9', price: 100, image: 'placeholder.jpg' }
    ],
    'step6-no-scent': [
        { name: 'Без аромата', price: 0, image: 'placeholder.jpg' }
    ],
    'step6-fruity-floral': [
        { name: 'Фруктово-цветочный аромат', price: 200, image: 'placeholder.jpg' },
        { name: 'Фруктово-цветочный аромат 2', price: 200, image: 'placeholder.jpg' },
        { name: 'Фруктово-цветочный аромат 3', price: 200, image: 'placeholder.jpg' },
        { name: 'Фруктово-цветочный аромат 4', price: 200, image: 'placeholder.jpg' },
        { name: 'Фруктово-цветочный аромат 5', price: 200, image: 'placeholder.jpg' }
    ],
    'step6-woody-fruity': [
        { name: 'Древесно-фруктовый аромат', price: 250, image: 'placeholder.jpg' },
        { name: 'Древесно-фруктовый аромат 2', price: 250, image: 'placeholder.jpg' },
        { name: 'Древесно-фруктовый аромат 3', price: 250, image: 'placeholder.jpg' },
        { name: 'Древесно-фруктовый аромат 4', price: 250, image: 'placeholder.jpg' },
        { name: 'Древесно-фруктовый аромат 5', price: 250, image: 'placeholder.jpg' }
    ],
    'step6-woody-floral': [
        { name: 'Древесно-цветочный аромат', price: 250, image: 'placeholder.jpg' },
        { name: 'Древесно-цветочный аромат 2', price: 250, image: 'placeholder.jpg' },
        { name: 'Древесно-цветочный аромат 3', price: 250, image: 'placeholder.jpg' },
        { name: 'Древесно-цветочный аромат 4', price: 250, image: 'placeholder.jpg' },
        { name: 'Древесно-цветочный аромат 5', price: 250, image: 'placeholder.jpg' }
    ],
    'step6-woody-musky': [
        { name: 'Древесно-мускусный аромат', price: 300, image: 'placeholder.jpg' },
        { name: 'Древесно-мускусный аромат 2', price: 300, image: 'placeholder.jpg' },
        { name: 'Древесно-мускусный аромат 3', price: 300, image: 'placeholder.jpg' },
        { name: 'Древесно-мускусный аромат 4', price: 300, image: 'placeholder.jpg' },
        { name: 'Древесно-мускусный аромат 5', price: 300, image: 'placeholder.jpg' }
    ]
};

document.addEventListener('DOMContentLoaded', function() {
    const progressBar = document.getElementById('progress');
    const currentStepDisplay = document.getElementById('current-step');
    const steps = document.querySelectorAll('.step');
    const productsDivs = Array.from(document.querySelectorAll('.products'));
    const selectedProductsDiv = document.getElementById('selected-products');
    const selectedProductsList = document.getElementById('selected-products-list');
    const totalPriceDisplay = document.getElementById('total-price');

    let currentStep = 1;
    let selectedProducts = [];
    let totalPrice = 0;
    let selectedCategories = {}; // Инициализация переменной

    function updateProgress() {
        const progressPercentage = ((currentStep - 1) / (steps.length - 1)) * 100;
        progressBar.style.width = `${progressPercentage}%`;
        currentStepDisplay.textContent = currentStep;
    }

    function hideAllSteps() {
        steps.forEach(step => step.style.display = 'none');
    }

    function showStep(stepNumber) {
        hideAllSteps();
        document.getElementById(`step${stepNumber}`).style.display = 'block';
        document.querySelector('.progress-container').style.display = (stepNumber === 7) ? 'none' : 'block';
        updateActiveCategoryHighlighting();
        selectedProductsDiv.style.display = selectedProducts.length > 0 ? 'block' : 'none';
    }

    function loadProducts(stepNumber, category = null) {
        const productsDiv = productsDivs[stepNumber - 1];
        productsDiv.innerHTML = '';

        // Обновляем выбранную категорию
        if (category) {
            selectedCategories[stepNumber] = category; // Сохраняем выбранную категорию
        }

        const productsToDisplay = category ? productsData[`step${stepNumber}-${category}`] || [] : getRandomProducts(9, stepNumber);
        if (stepNumber === 6) {
            productsToDisplay.length = 0; // Очищаем массив
            productsToDisplay.push(
                productsData['step6-no-scent'][0],
                productsData['step6-fruity-floral'][0],
                productsData['step6-woody-fruity'][0],
                productsData['step6-woody-floral'][0],
                productsData['step6-woody-musky'][0]
            );
        }

        productsToDisplay.forEach(product => {
            const productDiv = createProductDiv(product);
            productsDiv.appendChild(productDiv);
        });

        updateProductButtons(productsDiv);
    }

    function createProductDiv(product) {
        const productDiv = document.createElement('div');
        productDiv.classList.add('product');

        const img = document.createElement('img');
        img.src = product.image;
        img.alt = product.name;
        productDiv.appendChild(img);

        const productInfoDiv = document.createElement('div');
        productInfoDiv.classList.add('product-info');
        productInfoDiv.innerHTML = `
            <div class="product-name">${product.name}</div>
            <div class="product-price">${product.price === 0 ? 'Бесплатно' : `${product.price} рублей`}</div>
        `;
        productDiv.appendChild(productInfoDiv);

        const selectButton = document.createElement('button');
        selectButton.classList.add('select-button');
        selectButton.textContent = 'Выбрать';
        selectButton.dataset.name = product.name;
        selectButton.dataset.price = product.price;

        selectButton.addEventListener('click', selectProduct);
        productDiv.appendChild(selectButton);

        return productDiv;
    }

    function updateProductButtons(productsDiv) {
        const selectButtons = productsDiv.querySelectorAll('.select-button');
        selectButtons.forEach(button => {
            const product = { name: button.dataset.name, price: parseFloat(button.dataset.price) };
            if (isProductSelected(product)) {
                button.textContent = 'Удалить';
                button.classList.add('selected');
            } else {
                button.textContent = 'Выбрать';
                button.classList.remove('selected');
            }
        });
    }

    function isProductSelected(product) {
        return selectedProducts.some(p => p.name === product.name);
    }

    function selectProduct(event) {
        const productName = event.target.dataset.name;
        const productPrice = parseFloat(event.target.dataset.price);
        const product = { name: productName, price: productPrice, image: 'placeholder.jpg' };
        const selectButton = event.target;

        if (isProductSelected(product)) {
            removeProduct(product);
            selectButton.textContent = 'Выбрать';
            selectButton.classList.remove('selected');
        } else {
            selectedProducts.push(product);
            selectButton.textContent = 'Удалить';
            selectButton.classList.add('selected');
        }

        updateSelectedProductsDisplay();
        loadProducts(currentStep); // Обновляем кнопки продуктов
    }

    function removeProduct(product) {
        selectedProducts = selectedProducts.filter(p => p.name !== product.name);
        updateSelectedProductsDisplay();
    }

    function updateSelectedProductsDisplay() {
        selectedProductsList.innerHTML = ''; // Очищаем существующий вывод
        totalPrice = 0;

        selectedProducts.forEach((product, index) => {
            const selectedProductDiv = createSelectedProductDiv(product, index);
            selectedProductsList.appendChild(selectedProductDiv);
            totalPrice += product.price;
        });

        totalPriceDisplay.textContent = totalPrice > 0 ? totalPrice : '0';
        selectedProductsDiv.style.display = selectedProducts.length > 0 ? 'block' : 'none';
    }

    function createSelectedProductDiv(product, index) {
        const selectedProductDiv = document.createElement('div');
        selectedProductDiv.classList.add('selected-product');

        selectedProductDiv.innerHTML = `
            <img src="${product.image}" alt="${product.name}">
            <div class="product-name">${product.name}</div>
            <div class="product-price">${product.price === 0 ? 'Бесплатно' : `${product.price} рублей`}</div>
        `;

        const removeButton = document.createElement('button');
        removeButton.textContent = 'Удалить';
        removeButton.addEventListener('click', () => {
            removeProduct(product);
        });
        selectedProductDiv.appendChild(removeButton);

        return selectedProductDiv;
    }

    function updateActiveCategoryHighlighting() {
        document.querySelectorAll('.category-buttons button').forEach(button => {
            button.classList.remove('active');
        });

        const activeButton = document.querySelector(`.category-buttons button[data-category="${selectedCategories[currentStep]}"]`);
        if (activeButton) {
            activeButton.classList.add('active');
        }
    }

    function attachNavigationEventListeners(step) {
        const prevButton = step.querySelector('#prev-button');
        const nextButton = step.querySelector('#next-button');

        if (prevButton) {
            prevButton.addEventListener('click', () => {
                if (currentStep > 1) {
                    currentStep--;
                    showStep(currentStep);
                    updateProgress();
                }
            });
        }

        if (nextButton) {
            nextButton.addEventListener('click', () => {
                if (currentStep < steps.length) {
                    currentStep++;
                    showStep(currentStep);
                    updateProgress();
                }
            });
        }
    }

    // Привязываем обработчики событий к кнопкам навигации для каждого шага
    steps.forEach(step => {
        attachNavigationEventListeners(step);
    });

    // Изначальная настройка
    showStep(currentStep);
    updateProgress();
});
